trigger:
- main

pool:
  vmImage: ubuntu-latest

variables:
  KUBECONFIG: $(Pipeline.Workspace)/kubeconfig

steps:
- checkout: self

- script: |
    curl -sLO https://dl.k8s.io/release/$(curl -Ls https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl
    chmod +x kubectl
    sudo mv kubectl /usr/local/bin/kubectl
  displayName: Install kubectl

- script: |
    echo "$(KUBE_CONFIG_DATA)" | base64 --decode > $(KUBECONFIG)
    kubectl get nodes
  displayName: Connect to AKS

- script: |
    kubectl get ns k6 || kubectl create ns k6
    kubectl delete configmap k6-scripts -n k6 --ignore-not-found
    kubectl create configmap k6-scripts \
      --from-file=k6/Prod \
      -n k6
  displayName: Prepare k6 scripts

- script: |
    kubectl delete job k6-load-test -n k6 --ignore-not-found
    kubectl apply -f k8s/k6-job.yaml
    kubectl wait --for=condition=complete job/k6-load-test -n k6 --timeout=600s
    POD=$(kubectl get pods -n k6 -l job-name=k6-load-test -o jsonpath='{.items[0].metadata.name}')
    kubectl logs -n k6 $POD
  displayName: Run k6 load tests

- script: |
    python ci/ai_call.py
  displayName: AI Summary
  condition: and(succeeded(), eq(variables['AI_ENABLED'], 'true'))
